<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªØ±Ø§Ø¨Ø·Ø©</title>
  <style>
    body { font-family: Arial; background: #f9f9f9; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    button { padding: 6px 12px; }
    .footer-row td { background: #dff0d8; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
  <table id="timerTable">
    <thead>
      <tr>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
        <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
        <th>ØªÙ… Ø§Ù„ÙƒØ³Ø±</th>
        <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
        <th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody>
      {% for timer in timers %}
      <tr data-id="{{ timer.id }}">
        <td>{{ timer.start }}</td>
        <td>{{ timer.duration_str }}</td>
        <td>ØªÙ… Ø§Ù„ÙƒØ³Ø±</td>
        <td>{{ timer.final_str }}</td>
        <td><button onclick="deleteRow({{ timer.id }})">ğŸ—‘ Ø­Ø°Ù</button></td>
      </tr>
      {% endfor %}
      <!-- ØµÙ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙˆØ­ÙŠØ¯ -->
      <tr>
        <td><button onclick="startTimer(this)">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©</button></td>
        <td class="duration">--</td>
        <td><button onclick="stopTimer(this)">ØªÙ… Ø§Ù„ÙƒØ³Ø±</button></td>
        <td class="final">--</td>
        <td></td>
      </tr>
      <!-- ØµÙ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <tr class="footer-row">
        <td colspan="1">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</td>
        <td colspan="1">{{ stats.total }}</td>
        <td colspan="1">Ø§Ù„Ù…ØªÙˆØ³Ø·:</td>
        <td colspan="1">{{ stats.average }}</td>
        <td>Ø§Ù„Ø£Ø·ÙˆÙ„: {{ stats.maximum }}</td>
      </tr>
    </tbody>
  </table>

  <script>
    let startTime = null;
    let intervalId = null;

    function formatDuration(ms) {
      const totalSec = Math.floor(ms / 1000);
      const days = Math.floor(totalSec / 86400);
      const hours = Math.floor((totalSec % 86400) / 3600);
      const minutes = Math.floor((totalSec % 3600) / 60);
      const seconds = totalSec % 60;
      return `${days} ÙŠÙˆÙ… ${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ${seconds} Ø«Ø§Ù†ÙŠØ©`;
    }

    function startTimer(btn) {
      const td = btn.parentElement;
      const now = new Date();
      td.innerText = now.toISOString();
      startTime = now;

      const row = td.parentElement;
      const durationCell = row.querySelector(".duration");

      intervalId = setInterval(() => {
        const diff = Date.now() - startTime.getTime();
        durationCell.textContent = formatDuration(diff);
      }, 1000);
    }

    function stopTimer(btn) {
      if (!startTime) {
        alert("ÙŠØ¬Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©' Ø£ÙˆÙ„Ù‹Ø§");
        return;
      }

      clearInterval(intervalId);
      const now = new Date();
      const diffSec = Math.floor((now - startTime) / 1000);

      const row = btn.parentElement.parentElement;
      row.querySelector(".final").innerText = formatDuration(diffSec);

      fetch("/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: startTime.toISOString(),
          duration: diffSec,
          final_duration: diffSec
        })
      })
      .then(res => res.json())
      .then(() => location.reload());
    }

    function deleteRow(id) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
      fetch("/delete/" + id, { method: "POST" })
        .then(res => res.json())
        .then(() => location.reload());
    }
  </script>
</body>
</html>
