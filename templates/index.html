<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>عدادات مترابطة</title>
  <style>
    body { font-family: Arial; background: #f9f9f9; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    button { padding: 6px 12px; }
    .footer-row td { background: #dff0d8; font-weight: bold; }
  </style>
</head>
<body>
  <h2>العدادات</h2>
  <table id="timerTable">
    <thead>
      <tr>
        <th>تاريخ البداية</th>
        <th>المدة الحالية</th>
        <th>تم الكسر</th>
        <th>المدة النهائية</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody>
      {% for timer in timers %}
      <tr data-id="{{ timer.id }}">
        <td>{{ timer.start }}</td>
        <td>{{ timer.duration_str }}</td>
        <td>تم الكسر</td>
        <td>{{ timer.final_str }}</td>
        <td><button onclick="deleteRow({{ timer.id }})">🗑 حذف</button></td>
      </tr>
      {% endfor %}
      <!-- صف البداية الوحيد -->
      <tr>
        <td><button onclick="startTimer(this)">تاريخ اللحظة</button></td>
        <td class="duration">--</td>
        <td><button onclick="stopTimer(this)">تم الكسر</button></td>
        <td class="final">--</td>
        <td></td>
      </tr>
      <!-- صف الإحصائيات -->
      <tr class="footer-row">
        <td colspan="1">المجموع:</td>
        <td colspan="1">{{ stats.total }}</td>
        <td colspan="1">المتوسط:</td>
        <td colspan="1">{{ stats.average }}</td>
        <td>الأطول: {{ stats.maximum }}</td>
      </tr>
    </tbody>
  </table>

  <script>
    let startTime = null;
    let intervalId = null;

    function formatDuration(ms) {
      const totalSec = Math.floor(ms / 1000);
      const days = Math.floor(totalSec / 86400);
      const hours = Math.floor((totalSec % 86400) / 3600);
      const minutes = Math.floor((totalSec % 3600) / 60);
      const seconds = totalSec % 60;
      return `${days} يوم ${hours} ساعة ${minutes} دقيقة ${seconds} ثانية`;
    }

    function startTimer(btn) {
      const td = btn.parentElement;
      const now = new Date();
      td.innerText = now.toISOString();
      startTime = now;

      const row = td.parentElement;
      const durationCell = row.querySelector(".duration");

      intervalId = setInterval(() => {
        const diff = Date.now() - startTime.getTime();
        durationCell.textContent = formatDuration(diff);
      }, 1000);
    }

    function stopTimer(btn) {
      if (!startTime) {
        alert("يجب الضغط على 'تاريخ اللحظة' أولًا");
        return;
      }

      clearInterval(intervalId);
      const now = new Date();
      const diffSec = Math.floor((now - startTime) / 1000);

      const row = btn.parentElement.parentElement;
      row.querySelector(".final").innerText = formatDuration(diffSec);

      fetch("/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: startTime.toISOString(),
          duration: diffSec,
          final_duration: diffSec
        })
      })
      .then(res => res.json())
      .then(() => location.reload());
    }

    function deleteRow(id) {
      if (!confirm("هل أنت متأكد من الحذف؟")) return;
      fetch("/delete/" + id, { method: "POST" })
        .then(res => res.json())
        .then(() => location.reload());
    }
  </script>
</body>
</html>
