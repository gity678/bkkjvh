<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>عدادات مترابطة</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #aaa; padding: 10px; text-align: center; }
    th { background-color: #eee; }
    button { padding: 6px 10px; }
  </style>
</head>
<body>
  <h2>العدادات</h2>
  <table>
    <thead>
      <tr>
        <th>تاريخ البداية</th>
        <th>المدة الحالية</th>
        <th>تم الكسر</th>
        <th>المدة النهائية</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody>
      {% for timer in timers %}
      <tr data-id="{{ timer.id }}">
        <td>{{ timer.start }}</td>
        <td>{{ timer.duration }}</td>
        <td>تم الكسر</td>
        <td>{{ timer.final_duration }}</td>
        <td><button onclick="deleteRow({{ timer.id }})">🗑 حذف</button></td>
      </tr>
      {% endfor %}
      <tr>
        <td><button onclick="startTimer(this)">تاريخ اللحظة</button></td>
        <td class="duration">--:--:--</td>
        <td><button onclick="stopTimer(this)">تم الكسر</button></td>
        <td class="final">--:--:--</td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <script>
    let startTimes = new WeakMap();

    function formatDuration(ms) {
      const totalSec = Math.floor(ms / 1000);
      const hrs = String(Math.floor(totalSec / 3600)).padStart(2, '0');
      const min = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
      const sec = String(totalSec % 60).padStart(2, '0');
      return `${hrs}:${min}:${sec}`;
    }

    function startTimer(btn) {
      const td = btn.parentElement;
      const now = new Date();
      td.innerText = now.toISOString();
      startTimes.set(td, now);

      const row = td.parentElement;
      const durationCell = row.querySelector(".duration");

      const interval = setInterval(() => {
        const start = startTimes.get(td);
        if (!start) return;
        const diff = Date.now() - start.getTime();
        durationCell.textContent = formatDuration(diff);
      }, 1000);
    }

    function stopTimer(btn) {
      const row = btn.parentElement.parentElement;
      const startText = row.cells[0].innerText;
      const duration = row.cells[1].innerText;
      const startDate = new Date(startText);
      const now = new Date();
      const diff = now.getTime() - startDate.getTime();
      const finalDuration = formatDuration(diff);
      row.querySelector(".final").innerText = finalDuration;

      fetch("/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "timer",
          start: startText,
          duration: duration,
          final_duration: finalDuration
        })
      })
      .then(res => res.json())
      .then(res => {
        alert("✔ تم حفظ العداد");
        location.reload();
      });
    }

    function deleteRow(id) {
      if (!confirm("هل تريد حذف هذا الصف؟")) return;
      fetch("/delete/" + id, { method: "POST" })
        .then(res => res.json())
        .then(res => location.reload());
    }
  </script>
</body>
</html>
